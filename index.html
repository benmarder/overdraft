<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="includes/style.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js">
    </script>
    <!-- load D3js -->
    <script src="includes/d3.min.js"></script>

</head>

<body>
    <div id="viz"></div>
    <script>
        var innerWidth = window.innerWidth;
        var areaChartHeight = 0.09266667 * window.innerHeight;
        //var filterWidth=0.05171103 * innerWidth;
        //var areaChartWidth = innerWidth - filterWidth;
        var gap = innerWidth / 9;
        var left = -1 * gap;
        var years = "2002";
        var i = 0,a = 0;
                
        var treemap;
       
        var div = d3.select("#viz");
        $.getJSON("includes/Data Sets/2003-2011.json", function(data){
        	
        	 var year,sample_data,root;
         	 var year2003=data.y2003;
        	 var year2004=data.y2004;
        	 var year2005=data.y2005;
        	 var year2006=data.y2006;
        	 var year2007=data.y2007;
        	 var year2008=data.y2008;
        	 var year2009=data.y2009;
        	 var year2010=data.y2010;
        	 var year2011=data.y2011;
        var treeRation=[1.2,2,3	]	; 	   
		function createTreemap(name,fifths){
			switch (name){
				case "2003":year=year2003;break;
				case "2004":year=year2004;break;
				case "2005":year=year2005;break;
				case "2006":year=year2006;break;
				case "2007":year=year2007;break;
				case "2008":year=year2008;break;
				case "2009":year=year2009;break;
				case "2010":year=year2010;break;
				case "2011":year=year2011;break;
			}
			var treemap= d3.layout.treemap()
            .size([window.innerWidth, window.innerHeight - areaChartHeight])
            .sticky(true)
            .mode("squarify")
            .ratio(1.2)
            .value(function(d) {
                return d.value;
            });	 
				 sample_data = [{
                "value": year.categories.food.fifths[5],
            	"name": year.categories.food.name_he,
                "color":"#00a997",
                "pic": "images/chicken_icon.svg",
                "height_":335,
                "ratio":0.91044776
            }, {
                "value": year.categories.education_culture_and_entertainment.fifths[5],
           		"name": year.categories.education_culture_and_entertainment.name_he,
                "color":"#bacbe9",
                "pic": "images/culture_and_education_icon.svg",
                "height_":240,
                "ratio":0.85833333
            }, {
                "value": year.categories.housing_dwelling_and_household_maintenance.fifths[5],
            	"name": year.categories.housing_dwelling_and_household_maintenance.name_he,
                "color":"#e71f75",
                "pic": "images/diur_icon.svg",
                "height_":499,
                "ratio":0.87775551
            }, {
                "value": year.categories.miscellaneous_goods_and_services.fifths[5],
              	"name": year.categories.miscellaneous_goods_and_services.name_he,
                "color":"#1f2287",
                "pic": "images/cosmetics_icon.svg",
                "height_":192,
                "ratio":1.95833333
            }, {
                "value": year.categories.clothing_and_footwear.fifths[5],
            	"name": year.categories.clothing_and_footwear.name_he,
                "color":"#f9b349",
                "pic": "images/clothing_icon.svg",
                "height_":229,
                "ratio":1.83842795
            }, 
           	 	{
                "value": year.categories.health.fifths[5],
            	"name": year.categories.health.name_he,
                "color":"#db5567",
                "pic": "images/health_icon.svg",
                "height_":55,
                "ratio":2.8
            }, {
                "value": year.categories.transport_and_communications.fifths[5],
            	"name": year.categories.transport_and_communications.name_he,
                "color":"#8e4393",
                "pic": "images/communication_transportation_icon.svg",
                "height_":436,
                "ratio":0.83027523
            }];
             root = {
                'children': sample_data
            };	
		return treemap;	
		}
        	
      	  	 
       		treemap=createTreemap("2003").nodes;
            var node = div.datum(root).selectAll(".node")
                .data(treemap)
                .enter()
                .append("div")
                .attr("class", "node")
                .style("background", function(d) {
                    return d.color;
                })
                .call(appendImage)
                .append("div")
                .attr("class","text")
                .call(appendText_percent)
                .call(appendText_name);
                d3.selectAll(".node").call(position);
                
                
                
                function appendText_percent(){
                	this.append("text")
	            	.attr("class","percent");  	
                }
                function appendText_name(){
                	this.append("text")
	            	.attr("class","name");
	            		
                }
                function appendImage(){
                this.append("img")
	                .attr("src", function(d) {
	                    return d.pic;
	                });   
                }

          //  .on("click", function(e) {
            //    $(d3.event.target).toggleClass("active", true);
            //});
            
            	
     
        function position() {
        		
            this
            	.style("right", function(d) {
                    return d.x + "px";
                })
                .style("top", function(d) {
                    return d.y + "px";
                })
                .style("width", function(d) {
                    return Math.max(0, d.dx) + "px";
                })
                
                .style("height", function(d) {
                    return Math.max(0, d.dy) + "px";
                })
              		//set the picture area as 40% from the div area 
                .select("img")
	                .attr("height", function(d) { //new height= Square root(div area /(old height^2 * ratio)) * old height
	                    return Math.sqrt((d.dy*d.dx*0.35)/(d.height_*d.height_*d.ratio))*d.height_; 
	                })
	                .attr("width", function(d) {
	                    return (this.height) * d.ratio;
	                })
	                .style("top", function(d) {
	                	if(window.innerHeight/d.dy >2)
	                		return "6px";
	                    return ((d.dy-this.height)/2)+"px";
	                })
	                .style("left", function(d) {
	                    return ((d.dx-this.width)/2)+"px";
	                });
	              this.select(".percent") 
	               .transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-11+"%";
		            	})  	
		            	 .transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-10+"%";
		            	})  	
		            	 .transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-9+"%";
		            	})  	
	               	.transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-8+"%";
		            	})  	
		            .transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-7+"%";
		            	})  	
		            .transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-6+"%";
		            	}) 
	              	.transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-5+"%";
		            	})
		            	.transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-4+"%";
		            	})
		            	.transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-3+"%";
		            	})
		            	.transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-2+"%";
		            	}) 
		            	.transition()
	              	.duration(50)
	              	.text(function(d) {
		                	return (Math.round((d.value/year.fifths[5])*100))-1+"%";
		            	});
		            	
	              	
		            	
			      this.select(".name") 
			      	.text(function(d) {
	               				 return d.name;
               			});
  	
        }


        var lineData = [{
            "x": a += gap,
            "y": year2003.fifths[5]
        }, {
            "x": a += gap,
            "y": year2004.fifths[5]
        }, {
            "x": a += gap,
            "y": year2005.fifths[5]
        }, {
            "x": a += gap,
            "y": year2006.fifths[5]
        }, {
            "x": a += gap,
            "y": year2007.fifths[5]
        }, {
            "x": a += gap,
            "y": year2008.fifths[5]
        }, {
            "x": a += gap,
            "y": year2009.fifths[5]
        }, {
            "x": a += gap,
            "y": year2010.fifths[5]
        }, {
            "x": a += gap,
            "y": year2011.fifths[5]
        }];


        var svg = d3.select("body").append("svg")
            .attr("width", innerWidth)
            .attr("height", areaChartHeight)
            .style("top", innerHeight - areaChartHeight);

        var area = d3.svg.area()
            .interpolate("monotone")
            .x(function(d) {
                return x(d.x);
            })
            .y0(areaChartHeight)
            .y1(function(d) {
                return y(d.y);
            });


        var lineFunction = d3.svg.line()
            .x(function(d) {
                return d.x;
            })
            .y(function(d) {
                return d.y;
            });

        var x = d3.scale.linear().range([0, innerWidth]);
        var y = d3.scale.linear().range([areaChartHeight*3,0]);

        x.domain(d3.extent(lineData, function(d) {
            return d.x;
        }));
        y.domain([0, d3.max(lineData, function(d) {
            return d.y;
        })]);

        svg.append("path")
            .attr("class", "area")
            .attr("d", area(lineData));

        var linegraph = svg.append("path")
            .attr("d", lineFunction(lineData))
            .attr("stroke-width", 0)
            .attr("fill", "none");

        for (var i = 0; i < 9; ++i) {
            $("body").append("<section class='year' id="+(++years)+">" + (years) + "</section>");
            $(".year").eq(i).css({
                "width": gap,
                "height": areaChartHeight,
                "left": left += gap,
                "top": innerHeight - areaChartHeight
            });
        }
        
        //$("body").append("<section id='filter'>זה אני</section>");
        //$("#filter").css({"width":filterWidth,"height":areaChartHeight,"left":left+=gap});
        $(".year").click(function() {
            $(".yearSelected").removeClass("yearSelected");
            $(this).addClass("yearSelected");
            
           //  var treemap2 = d3.layout.treemap()
          //  .size([window.innerWidth, window.innerHeight - areaChartHeight])
          //  .sticky(true)
          //  .mode("squarify")
           // .ratio(1.2)
           // .value(function(d) {
            //    return d.value;
         //   });
      
         	treemap=createTreemap($(this).attr("id"));
            var node2 = div
   				.datum(root).selectAll(".node")
    			.data(createTreemap(treemap))
    			.transition()
    			.duration(1500)
    			.call(position);
   				 console.log("here");
		 });
      });
    </script>
</body>


</html>