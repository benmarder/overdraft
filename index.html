<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="includes/style.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js">
    </script>
    <!-- load D3js -->
    <script src="includes/d3.min.js"></script>

</head>

<body>
    <div id="viz"></div>
    <script>
        var innerWidth = window.innerWidth;
        var areaChartHeight = 0.09266667 * innerHeight;
        //var filterWidth=0.05171103 * innerWidth;
        //var areaChartWidth = innerWidth - filterWidth;
        var gap = innerWidth / 9;
        var left = -1 * gap;
        var year = "2003";
        var i = 0;
        var treemap = d3.layout.treemap()
            .size([window.innerWidth, window.innerHeight - areaChartHeight])
            .sticky(true)
            .mode("squarify")
            .ratio(1.2)
            .value(function(d) {
                return d.value;
            });
       

        var div = d3.select("#viz");
        $.getJSON("Data Sets/2003new.json", function(data) {	   
            // sample data array
            var sample_data = [{
                "value": data.categories.food.fifths[5],
                "name": data.categories.food.name_he,
                "color":"#00a997",
                "pic": "images/chicken_icon.svg",
                "height_":335,
                "ratio":0.91044776
            }, {
                "value": data.categories.education_culture_entertainment.fifths[5],
                "name": data.categories.education_culture_entertainment.name_he,
                "color":"#bacbe9",
                "pic": "images/culture_and_education_icon.svg",
                "height_":240,
                "ratio":0.85833333
            }, {
                "value": data.categories.housing_dwelling_and_household_maintenance.fifths[5],
                "name": data.categories.housing_dwelling_and_household_maintenance.name_he,
                "color":"#e71f75",
                "pic": "images/diur_icon.svg",
                "height_":499,
                "ratio":0.87775551
            }, {
                "value": data.categories.miscellaneous_goods_and_services.fifths[5],
                "name": data.categories.miscellaneous_goods_and_services.name_he,
                "color":"#1f2287",
                "pic": "images/cosmetics_icon.svg",
                "height_":192,
                "ratio":1.95833333
            }, {
                "value": data.categories.clothing_and_footwear.fifths[5],
                "name": data.categories.clothing_and_footwear.name_he,
                "color":"#f9b349",
                "pic": "images/clothing_icon.svg",
                "height_":229,
                "ratio":1.83842795
            }, 
           	 	{
                "value": data.categories.health.fifths[5],
                "name": data.categories.health.name_he,
                "color":"#db5567",
                "pic": "images/health_icon.svg",
                "height_":55,
                "ratio":2.8
            }, {
                "value": data.categories.transport_and_communication.fifths[5],
                "name": data.categories.transport_and_communication.name_he,
                "color":"#8e4393",
                "pic": "images/communication_transportation_icon.svg",
                "height_":436,
                "ratio":0.83027523
            }];
            var root = {
                'children': sample_data
            };


            var node = div.datum(root).selectAll(".node")
                .data(treemap.nodes)
                .enter().append("div")
                .attr("class", "node")
                .call(position)
                .style("background", function(d) {
                    return d.color;
                })

            .on("click", function(e) {
                $(d3.event.target).toggleClass("active", true);
            });
            node.append("img")
                //.attr("height",function(d) { console.log(d.dx);return d.dx*0.5; })
                .attr("src", function(d) {
                    return d.pic;
                })
                //set the picture area as 40% from the div area 
                .attr("height", function(d) { //new height= Square root(div area /(old height^2 * ratio)) * old height
                    return Math.sqrt((d.dy*d.dx*0.4)/(d.height_*d.height_*d.ratio))*d.height_; 
                })
                .attr("width", function(d) {
                    return (this.height) * d.ratio;
                })
                .style("top", function(d) {
                    return ((d.dy-this.height)/2)+"px";
                })
                .style("left", function(d) {
                    return ((d.dx-this.width)/2)+"px";
                });
                
                
                
            node.append("text")
            	.attr("id","name")
            	.text(function(d) {
                	return d.name;
            });
            node.append("text")
            	.attr("id","percent")
            	.text(function(d) {
                	return (Math.round((d.value/data.fifths[5])*100))+"%";
            });
        });

        function position() {
            this.style("right", function(d) {
                    return d.x + "px";
                })
                .style("top", function(d) {
                    return d.y + "px";
                })
                .style("width", function(d) {
                    return Math.max(0, d.dx) + "px";
                })
                
                .style("height", function(d) {
                    return Math.max(0, d.dy) + "px";
                });
        }


        var lineData = [{
            "x": i += gap,
            "y": 250
        }, {
            "x": i += gap,
            "y": 170
        }, {
            "x": i += gap,
            "y": 140
        }, {
            "x": i += gap,
            "y": 220
        }, {
            "x": i += gap,
            "y": 220
        }, {
            "x": i += gap,
            "y": 190
        }, {
            "x": i += gap,
            "y": 170
        }, {
            "x": i += gap,
            "y": 140
        }, {
            "x": i += gap,
            "y": 200
        }];


        var svg = d3.select("body").append("svg")
            .attr("width", innerWidth)
            .attr("height", areaChartHeight)
            .style("top", innerHeight - areaChartHeight);

        var area = d3.svg.area()
            .interpolate("monotone")
            .x(function(d) {
                return x(d.x);
            })
            .y0(areaChartHeight)
            .y1(function(d) {
                return y(d.y);
            });


        var lineFunction = d3.svg.line()
            .x(function(d) {
                return d.x;
            })
            .y(function(d) {
                return d.y;
            });

        var x = d3.scale.linear().range([0, innerWidth]);
        var y = d3.scale.linear().range([0, 50]);

        x.domain(d3.extent(lineData, function(d) {
            return d.x;
        }));
        y.domain([0, d3.max(lineData, function(d) {
            return d.y;
        })]);

        svg.append("path")
            .attr("class", "area")
            .attr("d", area(lineData));

        var linegraph = svg.append("path")
            .attr("d", lineFunction(lineData))
            .attr("stroke", "red")
            .attr("stroke-width", 0)
            .attr("fill", "none");

        for (var i = 0; i < 9; ++i) {
            $("body").append("<section class='year'>" + (year++) + "</section>");
            $(".year").eq(i).css({
                "width": gap,
                "height": areaChartHeight,
                "left": left += gap,
                "top": innerHeight - areaChartHeight
            });
        }
        //$("body").append("<section id='filter'>זה אני</section>");
        //$("#filter").css({"width":filterWidth,"height":areaChartHeight,"left":left+=gap});
        $(".year").click(function() {
            $(".yearSelected").removeClass("yearSelected");
            $(this).addClass("yearSelected");

        });
    </script>
</body>


</html>